# 新功能文档 / New Features Documentation

本文档介绍了高考志愿推荐系统的两个新功能：位次分析与趋势预测、志愿表生成与导出。

## 目录 / Table of Contents

1. [位次分析与趋势预测](#位次分析与趋势预测)
2. [志愿表生成与导出](#志愿表生成与导出)
3. [技术实现](#技术实现)
4. [使用指南](#使用指南)

---

## 位次分析与趋势预测

### 功能概述

位次分析功能帮助考生了解目标院校专业的历史录取趋势，通过数据分析预测未来录取位次，评估录取风险。

### 核心功能

1. **历史数据展示**
   - 显示近3-5年的录取数据
   - 包含年份、最低分数、最低位次

2. **趋势分析**
   - 自动计算位次变化趋势（上升/下降/稳定）
   - 使用线性回归分析历史数据
   - 提供趋势描述和解读

3. **位次预测**
   - 基于历史数据预测今年可能的录取位次
   - 提供置信区间（预测位次 ± 1.5×标准差）
   - 可视化展示预测结果

4. **波动程度评估**
   - 计算历史位次的标准差
   - 分为低波动、中波动、高波动三个等级
   - 帮助判断录取稳定性

5. **风险评估**
   - 输入考生位次后，评估录取风险
   - 分为低风险、中风险、高风险三个等级
   - 基于位次与预测范围的关系判断

### 使用方法

1. 登录系统后，点击导航栏的"位次分析"
2. 选择省份和考试类型
3. 输入目标学校和专业名称
4. （可选）输入您的位次以获得风险评估
5. 点击"开始分析"查看结果

### 页面元素

- **输入表单**：省份、考试类型、学校、专业、位次
- **趋势图表**：使用Chart.js绘制的折线图，展示历年位次变化
- **关键指标卡片**：趋势、预测位次、波动程度、风险评估
- **历年数据表格**：详细的历史录取数据

---

## 志愿表生成与导出

### 功能概述

志愿表管理功能允许用户收藏心仪的院校专业，按"冲稳保"分类整理，并导出为打印版志愿表。

### 核心功能

1. **收藏志愿**
   - 在推荐结果页面，点击心形图标收藏志愿
   - 自动分类到冲/稳/保
   - 防止重复收藏

2. **志愿管理**
   - 三栏布局展示冲/稳/保志愿
   - 拖拽排序（支持跨栏拖动）
   - 编辑分类和备注
   - 删除不需要的志愿

3. **预览与导出**
   - 预览完整志愿表
   - 使用浏览器打印功能导出PDF
   - 打印样式优化，适合纸质存档

### 数据结构

每个收藏的志愿包含：
- 学校名称
- 专业名称
- 分类（冲/稳/保）
- 排序序号
- 备注信息
- 创建时间

### 使用方法

#### 添加志愿
1. 在推荐页面获取推荐结果
2. 找到心仪的学校专业
3. 点击右侧的心形图标
4. 志愿自动添加到志愿表

#### 管理志愿
1. 点击导航栏的"志愿表"
2. 在三栏布局中查看已收藏的志愿
3. 拖动志愿卡片调整顺序或分类
4. 点击编辑图标修改分类或添加备注
5. 点击删除图标移除志愿

#### 导出志愿表
1. 在志愿表页面点击"预览志愿表"
2. 检查志愿顺序和信息
3. 点击"打印志愿表"
4. 在浏览器打印对话框中选择"保存为PDF"或直接打印

### 页面元素

- **三栏布局**：冲/稳/保分类展示
- **志愿卡片**：显示学校、专业、备注，支持拖拽
- **操作按钮**：预览、打印、刷新
- **编辑模态框**：修改分类和备注

---

## 技术实现

### 后端架构

#### 分析模块 (`analysis.py`)

```python
# 核心函数
get_historical_data()      # 获取历史数据
calculate_trend()          # 计算趋势
predict_rank()             # 预测位次
calculate_volatility()     # 计算波动
get_risk_level()          # 评估风险
get_volatility_level()    # 波动等级
```

**算法说明：**
- **趋势判断**：线性回归计算斜率
  - slope < -100：上升趋势（竞争加剧）
  - slope > 100：下降趋势（竞争降低）
  - 其他：稳定趋势
  
- **位次预测**：y = slope × x + intercept
  - 置信区间 = 预测值 ± 1.5 × 标准差

- **风险评估**：
  - 学生位次 < 预测下限 → 低风险
  - 学生位次在预测范围内 → 中风险
  - 学生位次 > 预测上限 → 高风险

#### API路由

**位次分析：**
- `GET /analysis-page` - 分析页面
- `GET /api/analysis/<school>/<major>` - 分析API
  - 参数：province, exam_type, student_rank（可选）
  - 返回：历史数据、趋势、预测、风险评估

**志愿表管理：**
- `GET /wishlist` - 志愿表页面
- `GET /api/favorites` - 获取收藏列表
- `POST /api/favorites` - 添加收藏
- `DELETE /api/favorites` - 删除收藏
- `PUT /api/favorites/<id>` - 更新收藏
- `POST /api/favorites/reorder` - 调整顺序

### 数据库设计

#### user_favorites 表

```sql
CREATE TABLE user_favorites (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    school TEXT NOT NULL,
    major TEXT NOT NULL,
    category TEXT DEFAULT '稳',
    sort_order INTEGER DEFAULT 0,
    note TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE(user_id, school, major)
);

CREATE INDEX idx_favorites_user ON user_favorites(user_id);
```

### 前端技术

1. **Chart.js** - 趋势图表绘制
   - 折线图展示历年位次变化
   - 预测点用不同颜色标识
   - Y轴反转（位次越小越好）

2. **SortableJS** - 拖拽排序
   - 支持跨列表拖动
   - 自动更新分类
   - 平滑动画效果

3. **响应式设计**
   - Bootstrap 5栅格系统
   - 移动端适配
   - 打印样式优化

### 安全措施

1. **XSS防护**
   - 使用 `textContent` 而非 `innerHTML`
   - `addEventListener` 代替内联事件处理

2. **SQL注入防护**
   - 参数化查询
   - 预定义SQL语句
   - 输入验证

3. **认证授权**
   - `@login_required` 装饰器
   - 用户ID验证
   - 外键约束

---

## 使用指南

### 快速开始

1. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

2. **启动应用**
   ```bash
   cd college-recommender
   python app.py
   ```

3. **登录系统**
   - 访问 http://localhost:5000
   - 注册新用户或使用管理员账号（admin / admin123）

4. **完善个人资料**
   - 点击"个人资料"
   - 填写省份、考试类型、位次

### 典型使用流程

#### 场景1：分析目标院校

1. 获取推荐结果后，发现感兴趣的学校
2. 点击"位次分析"
3. 输入该校信息查看趋势
4. 根据风险评估决定是否收藏

#### 场景2：整理志愿表

1. 浏览推荐结果，收藏多个志愿
2. 进入"志愿表"页面
3. 按照自己的偏好调整顺序
4. 为每个志愿添加备注（如：专业排名、地理位置等）
5. 在冲/稳/保之间拖动调整分类
6. 最终导出打印版志愿表

#### 场景3：志愿填报准备

1. 系统推荐 → 位次分析 → 收藏志愿
2. 整理志愿表 → 调整顺序 → 添加备注
3. 预览 → 打印 → 线下填报

### 注意事项

1. **数据准确性**
   - 预测仅供参考，不保证100%准确
   - 建议结合多个维度综合判断
   - 关注学校官方招生信息

2. **志愿数量**
   - 建议冲稳保比例：30% - 40% - 30%
   - 注意平行志愿规则
   - 确保有足够的保底选择

3. **使用建议**
   - 定期更新志愿表
   - 导出前仔细核对信息
   - 保存多个版本以便对比

---

## 常见问题

### Q: 为什么没有找到某学校的历史数据？
**A:** 可能原因：
- 该校在您选择的省份/类型下没有招生
- 数据库中暂未录入该校数据
- 学校或专业名称输入有误

### Q: 预测位次的准确性如何？
**A:** 预测基于线性回归模型，考虑了：
- 历史趋势
- 数据波动性
- 置信区间

但以下因素可能影响准确性：
- 招生计划变化
- 专业热度波动
- 高考政策调整

### Q: 如何导出志愿表为PDF？
**A:** 使用浏览器打印功能：
1. 点击"打印志愿表"
2. 在打印对话框选择目标打印机或"保存为PDF"
3. 调整页面设置（纸张大小、方向等）
4. 点击打印/保存

### Q: 志愿表是否有数量限制？
**A:** 
- 理论上无数量限制
- 建议控制在合理范围内（20-30个）
- 注意各省志愿填报规则

### Q: 拖拽排序后如何保存？
**A:** 
- 拖拽完成后自动保存
- 刷新页面验证是否保存成功
- 如有问题，使用"刷新"按钮重新加载

---

## 更新日志

### v2.0.0 (2025-12-15)

#### 新增功能
- ✨ 位次分析与趋势预测模块
- ✨ 志愿表收藏与管理功能
- ✨ 拖拽排序交互
- ✨ Chart.js数据可视化
- ✨ 志愿表预览与打印

#### 技术改进
- 🔒 XSS漏洞修复
- 🔒 SQL注入防护
- 📝 添加代码注释和常量定义
- ♻️ 优化数据库查询性能
- 🎨 响应式设计优化

#### 安全增强
- CodeQL安全扫描通过（0漏洞）
- 输入验证和输出转义
- 参数化查询防注入

---

## 技术支持

如有问题或建议，请：
1. 查看本文档的常见问题部分
2. 提交 [GitHub Issue](https://github.com/FairyBlue7/college-recommended-system/issues)
3. 联系开发团队

---

## 许可证

MIT License

---

**祝您志愿填报顺利！** 🎓
