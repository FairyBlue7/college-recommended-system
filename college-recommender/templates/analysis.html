<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ä½æ¬¡åˆ†æä¸è¶‹åŠ¿é¢„æµ‹ - é«˜è€ƒå¿—æ„¿æ¨èç³»ç»Ÿ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: "Microsoft YaHei", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.6;
            padding: 15px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 25px;
        }
        header h1 {
            font-size: 2rem;
            color: #1a3a6c;
            margin-bottom: 10px;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.12);
            overflow: hidden;
            margin-bottom: 30px;
        }
        .card-header {
            background: linear-gradient(to right, #1a3a6c, #2c5aa0);
            color: white;
            padding: 18px 25px;
            font-size: 1.3rem;
            font-weight: 600;
        }
        .card-body {
            padding: 25px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dce4ef;
            border-radius: 8px;
            font-size: 1rem;
        }
        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        .btn-primary {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6);
        }
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .nav-bar a {
            text-decoration: none;
            color: #3498db;
            font-weight: 500;
            margin: 0 10px;
        }
        .nav-bar a:hover {
            color: #2980b9;
        }
        .result-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .result-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .info-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        .info-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }
        .trend-up { color: #e74c3c; }
        .trend-down { color: #27ae60; }
        .trend-stable { color: #f39c12; }
        .risk-low { 
            color: #27ae60; 
            background: #d5f4e6;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }
        .risk-medium { 
            color: #f39c12;
            background: #fef5e7;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }
        .risk-high { 
            color: #e74c3c;
            background: #fadbd8;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #dee2e6;
        }
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #fef2f2;
            color: #b91c1c;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ef4444;
        }
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> ä½æ¬¡åˆ†æä¸è¶‹åŠ¿é¢„æµ‹</h1>
            <p>æ·±å…¥åˆ†æé™¢æ ¡ä¸“ä¸šçš„å†å²å½•å–æ•°æ®ï¼Œç§‘å­¦é¢„æµ‹å½•å–é£é™©</p>
        </header>

        <div class="nav-bar">
            <div>
                <a href="/recommend-page"><i class="fas fa-home"></i> è¿”å›æ¨è</a>
                <a href="/announcements"><i class="fas fa-bell"></i> å…¬å‘Š</a>
                <a href="/profile"><i class="fas fa-user-edit"></i> ä¸ªäººèµ„æ–™</a>
            </div>
            <div>
                <span>æ¬¢è¿ï¼Œ<strong>{{ username }}</strong></span>
                <a href="/logout" style="color: #e74c3c; margin-left: 15px;"><i class="fas fa-sign-out-alt"></i> é€€å‡º</a>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-search"></i> é€‰æ‹©å­¦æ ¡å’Œä¸“ä¸š
            </div>
            <div class="card-body">
                <form id="analysisForm">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="province"><i class="fas fa-map-marker-alt"></i> çœä»½</label>
                                <select id="province" name="province" class="form-control" required>
                                    <option value="å¹¿ä¸œ" selected>å¹¿ä¸œ</option>
                                    <option value="åŒ—äº¬">åŒ—äº¬</option>
                                    <option value="ä¸Šæµ·">ä¸Šæµ·</option>
                                    <option value="æ±Ÿè‹">æ±Ÿè‹</option>
                                    <option value="æµ™æ±Ÿ">æµ™æ±Ÿ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="exam_type"><i class="fas fa-book"></i> è€ƒè¯•ç±»å‹</label>
                                <select id="exam_type" name="exam_type" class="form-control" required>
                                    <option value="ç‰©ç†ç±»" selected>ç‰©ç†ç±»</option>
                                    <option value="å†å²ç±»">å†å²ç±»</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="school"><i class="fas fa-university"></i> å­¦æ ¡åç§°</label>
                                <input type="text" id="school" name="school" class="form-control" 
                                       placeholder="ä¾‹å¦‚ï¼šä¸­å±±å¤§å­¦" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="major"><i class="fas fa-graduation-cap"></i> ä¸“ä¸šåç§°</label>
                                <input type="text" id="major" name="major" class="form-control" 
                                       placeholder="ä¾‹å¦‚ï¼šè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="student_rank"><i class="fas fa-sort-numeric-down"></i> æ‚¨çš„ä½æ¬¡ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="number" id="student_rank" name="student_rank" class="form-control" 
                                       placeholder="è¾“å…¥æ‚¨çš„ä½æ¬¡ä»¥è¯„ä¼°å½•å–é£é™©" min="1">
                            </div>
                        </div>
                        <div class="col-md-6" style="display: flex; align-items: flex-end;">
                            <button type="submit" class="btn-primary" style="width: 100%;">
                                <i class="fas fa-chart-line"></i> å¼€å§‹åˆ†æ
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="result"></div>
    </div>

    <script>
        let trendChart = null;

        document.getElementById('analysisForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const school = document.getElementById('school').value.trim();
            const major = document.getElementById('major').value.trim();
            const province = document.getElementById('province').value;
            const examType = document.getElementById('exam_type').value;
            const studentRank = document.getElementById('student_rank').value;
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åˆ†ææ•°æ®...</div>';
            
            try {
                let url = `/api/analysis/${encodeURIComponent(school)}/${encodeURIComponent(major)}?province=${province}&exam_type=${examType}`;
                if (studentRank) {
                    url += `&student_rank=${studentRank}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    resultDiv.innerHTML = `<div class="card"><div class="card-body"><div class="error"><i class="fas fa-exclamation-circle"></i> ${data.error}</div></div></div>`;
                    return;
                }
                
                displayResults(data);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="card"><div class="card-body"><div class="error"><i class="fas fa-exclamation-circle"></i> åˆ†æå¤±è´¥: ${error.message}</div></div></div>`;
            }
        });
        
        function displayResults(data) {
            const trendClass = data.trend === 'ä¸Šå‡' ? 'trend-up' : (data.trend === 'ä¸‹é™' ? 'trend-down' : 'trend-stable');
            const trendIcon = data.trend === 'ä¸Šå‡' ? 'fa-arrow-trend-up' : (data.trend === 'ä¸‹é™' ? 'fa-arrow-trend-down' : 'fa-minus');
            
            let riskHtml = '';
            if (data.risk_assessment) {
                const riskClass = data.risk_assessment === 'ä½é£é™©' ? 'risk-low' : (data.risk_assessment === 'ä¸­é£é™©' ? 'risk-medium' : 'risk-high');
                riskHtml = `
                    <div class="info-item">
                        <div class="info-label">å½•å–é£é™©è¯„ä¼°</div>
                        <div class="info-value">
                            <span class="${riskClass}">${data.risk_assessment}</span>
                        </div>
                    </div>
                `;
            }
            
            const html = `
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-bar"></i> ${data.school} - ${data.major}
                    </div>
                    <div class="card-body">
                        <div class="result-card">
                            <div class="result-title">ğŸ“Š å…³é”®æŒ‡æ ‡</div>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">è¶‹åŠ¿</div>
                                    <div class="info-value ${trendClass}">
                                        <i class="fas ${trendIcon}"></i> ${data.trend}
                                    </div>
                                    <small>${data.trend_description}</small>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">é¢„æµ‹ä½æ¬¡</div>
                                    <div class="info-value">${data.predicted_rank}</div>
                                    <small>ç½®ä¿¡åŒºé—´: ${data.predicted_range.min} - ${data.predicted_range.max}</small>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">æ³¢åŠ¨ç¨‹åº¦</div>
                                    <div class="info-value">${data.volatility}</div>
                                    <small>æ ‡å‡†å·®: ${data.volatility_value}</small>
                                </div>
                                ${riskHtml}
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <div class="result-title">ğŸ“ˆ å†å¹´ä½æ¬¡è¶‹åŠ¿å›¾</div>
                            <div class="chart-container">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <div class="result-title">ğŸ“‹ å†å¹´å½•å–æ•°æ®</div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>å¹´ä»½</th>
                                        <th>æœ€ä½åˆ†æ•°</th>
                                        <th>æœ€ä½ä½æ¬¡</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.historical_data.map(d => `
                                        <tr>
                                            <td>${d.year}</td>
                                            <td>${d.min_score}</td>
                                            <td>${d.min_rank}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('result').innerHTML = html;
            
            // Draw chart
            drawTrendChart(data);
        }
        
        function drawTrendChart(data) {
            if (trendChart) {
                trendChart.destroy();
            }
            
            const ctx = document.getElementById('trendChart').getContext('2d');
            const years = data.historical_data.map(d => d.year);
            const ranks = data.historical_data.map(d => d.min_rank);
            
            // Add predicted point
            const nextYear = Math.max(...years) + 1;
            const chartYears = [...years, nextYear];
            const chartRanks = [...ranks, data.predicted_rank];
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartYears,
                    datasets: [{
                        label: 'æœ€ä½ä½æ¬¡',
                        data: chartRanks,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.3,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: chartYears.map((y, i) => i === chartYears.length - 1 ? '#e74c3c' : '#3498db')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    if (index === chartYears.length - 1) {
                                        return `é¢„æµ‹ä½æ¬¡: ${context.parsed.y}`;
                                    }
                                    return `æœ€ä½ä½æ¬¡: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            reverse: true,
                            title: {
                                display: true,
                                text: 'ä½æ¬¡ï¼ˆè¶Šå°è¶Šå¥½ï¼‰'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'å¹´ä»½'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
